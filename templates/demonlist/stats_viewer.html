{% extends "base.html" %}
{% load static %}

{% block head_content %}
    <title>Stats Viewer</title>
    <link rel="stylesheet" href="{% static 'css/stats.css' %}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
{% endblock%}
    
{% block container %}

    <main>
        <div class="stats-container" id="stats-container">
            <h2>Top Players</h2>
            <form class="stats-inputs-container" id="formulario" method="GET" action="{% url 'demonlist:stats_viewer' %}">
                <input type="hidden" id="mode" name="mode" value="platformer">
                <input type="hidden" id="category" name="category">
                <button class="rated-filter-button outside-filter-button" type="button">Rated</button>
                <button class="unrated-filter-button outside-filter-button" type="button">Unrated</button>
                <button class="tiny-filter-button outside-filter-button" type="button">Tiny</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in players %}
                    <tr>
                        <td>{{player.position}}</td>
                        <td>{{player}}</td>
                        <td>{{player.list_points}} points</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <script src="{% static 'js/statsviewer.js' %}?v=1.25"></script>

    <script>

        function show_team_members(id, list_filter) {
            data = {}
            data.option = "show_team_members";
            data.id = id;
            data.list_filter = list_filter;
            $.ajax({
                type: "post", // "post" "get" "delete" "put"
                data: data, // PREFERIBLEMENTE JSON
                cache: false,
                headers: {
                    "X-CSRFToken": Cookies.get("csrftoken")
                },
                success: function (response) {
                    document.body.classList.add('popup-open_members');
                    pop_up = `<div class="team-modal-container">
        
                        <div class="modal-data card-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">
            
                            <div class="close-modal-button-container">
            
                                <button class="close-modal-button--team " onclick="hide_members()">
                                    <svg class="text-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M1.4981 1.52299C0.833966 2.22033 0.833966 3.35092 1.4981 4.04826L7.59498 10.45L1.4981 16.8518C0.833966 17.5491 0.833966 18.6797 1.4981 19.377C2.16221 20.0743 3.23898 20.0743 3.9031 19.377L9.99999 12.9752L16.0969 19.377C16.761 20.0743 17.8378 20.0743 18.5019 19.377C19.166 18.6797 19.166 17.5491 18.5019 16.8518L12.405 10.45L18.5019 4.04828C19.166 3.35096 19.166 2.22035 18.5019 1.52303C17.8376 0.825687 16.761 0.825687 16.0969 1.52303L9.99999 7.92472L3.9031 1.52299C3.23898 0.825669 2.16221 0.825669 1.4981 1.52299Z" fill="#C0C0D1" />
    </svg>
                                </button>
            
                            </div>
            
                            <p class="text-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">{{list_words.team_members}}</p>
            
                            <span>
                                <svg class="stroke-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M13.3737 13.8876L18 18.5M15.3333 9.16667C15.3333 12.8485 12.3485 15.8333 8.66667 15.8333C4.98476 15.8333 2 12.8485 2 9.16667C2 5.48476 4.98476 2.5 8.66667 2.5C12.3485 2.5 15.3333 5.48476 15.3333 9.16667Z" stroke="#C0C0D1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
                                <input class="button-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode text-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode" type="text" placeholder="{{list_words.search}}..." oninput="search_member(` + id + `, this, '` + list_filter + `');">
                            </span>
            
            
                            <div class="data-container card-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode" id="user-container_members">`
            
                    $(response).each(function (index, player) {
                        pop_up += `<div class="data content-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">
                            `
                        if (player.picture) {
                            pop_up += `<img src="` + player.picture + `" alt="player-picture">`
                        }
                        else {
                            pop_up += `<img src="{% static 'img/default-profile.png' %}" alt="default-picture">`
                        }
                        pop_up += `<a href="{% url 'demonlist:category_or_username' 1234 %}" class="player-link text-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">`.replace(/1234/, player.user__username) + player.user__username + `</a>`
                        if (player.if_owner) {
                            pop_up += `<i class="fa-solid fa-crown ml-3 crown-icon"></i>`
                        }
                        pop_up += `<p class="member-points text-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">` + player.list_points + `</p></div>`
                    })
                    pop_up += `</div>
                        </div>
                    </div>`
                    $('body').append(pop_up)
        
                }
            })
        }
        
        function search_member(id, member, list_filter) {
            data = {}
            data.id = id;
            data.member = member.value;
            data.option = "show_team_members";
            data.list_filter = list_filter;
            $.ajax({
                type: "post", // "post" "get" "delete" "put"
                data: data, // PREFERIBLEMENTE JSON
                cache: false,
                headers: {
                    "X-CSRFToken": Cookies.get("csrftoken")
                },
                success: function (response) {
                    $("#user-container_members").empty();
        
                    $(response).each(function (index, user) {
                        fila = `<div class="data content-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">`
                        if (user.picture) {
                            photo = `<img src="` + user.picture + `" alt="player-picture"/>`
                        }
                        else {
                            photo = `<img src="{% static 'img/default-profile.png' %}" alt="default-picture"/>`
                        }
                        fila += photo
        
                        fila += `<a href="{% url 'demonlist:category_or_username' 1234 %}`.replace(/1234/, user.user__username) + `" class="player-link text-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">` + user.user__username + `</a>`
                        if (user.if_owner) {
                            fila += `<i class="fa-solid fa-crown ml-3 crown-icon"></i>`
                        }
                        fila += `<p class="member-points text-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode">` + user.list_points + `</p></div>`
                        $('#user-container_members').append(fila);
                    })
                }
            })
        }
    
        function define_vars(){
            var ratedButton = document.querySelector('.rated-filter-button');
            var unratedButton = document.querySelector('.unrated-filter-button');
            var tinyButton = document.querySelector('.tiny-filter-button');
            var modeInput = document.getElementById('mode');
            var categoryInput = document.getElementById('category');
            
            ratedButton.addEventListener('click', function() {
                categoryInput.value = 'rated';
                ratedButton.classList.add("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
                unratedButton.classList.remove("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
                tinyButton.classList.remove("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
            });

            unratedButton.addEventListener('click', function() {
                categoryInput.value = 'unrated';
                unratedButton.classList.add("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
                ratedButton.classList.remove("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
                tinyButton.classList.remove("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
            });
        
            tinyButton.addEventListener('click', function() {
                categoryInput.value = 'tiny';
                tinyButton.classList.add("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
                ratedButton.classList.remove("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
                unratedButton.classList.remove("filter-button-active-{% if request.global_context.dark_mode %}dark{% else %}light{% endif %}mode");
            });
        }
    
    </script>

    <script>
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        const particles = [];
        const particleCount = 100;

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
                this.color = `hsla(${195 + Math.random() * 30}, 100%, 70%, ${0.3 + Math.random() * 0.4})`;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            particles.forEach((a, i) => {
                particles.slice(i + 1).forEach(b => {
                    const dx = a.x - b.x;
                    const dy = a.y - b.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 100) {
                        const opacity = (1 - distance / 100) * 0.3;
                        ctx.strokeStyle = `rgba(0, 170, 255, ${opacity})`;
                        ctx.beginPath();
                        ctx.moveTo(a.x, a.y);
                        ctx.lineTo(b.x, b.y);
                        ctx.stroke();
                    }
                });
            });

            requestAnimationFrame(animate);
        }

        animate();
    </script>

{% endblock%}